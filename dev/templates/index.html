<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>GUI</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
        integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <h1 class="title">Lab 3 - Grupo 1 :)</h1>
    <div class="_d-flex _flex-column">
        <div class="control-element">
            Bra√ßo:
            <span class="badge badge-light" id="armText"></span>
            <button type="button" class="btn btn-primary" title="arm" onclick="incrementValue(this)">+</button>
            <button type="button" class="btn btn-warning" title="arm" onclick="decrementValue(this)">-</button>
            Valor desejado: <input class="input-control" title="arm" id="arm" value="" onfocusout="updateValue(this)"
                onkeydown="updateValueEnter(this)"></input>
        </div>
        <div class="control-element">
            Crab:
            <span class="badge badge-light" id="crabText"></span>
            <button type="button" class="btn btn-primary" title="crab" onclick="incrementValue(this)">+</button>
            <button type="button" class="btn btn-warning" title="crab" onclick="decrementValue(this)">-</button>
            Valor desejado: <input class="input-control" title="crab" id="crab" value="" onfocusout="updateValue(this)"
                onkeydown="updateValueEnter(this)"></input>
        </div>
        <div class="control-element">
            Hoist:
            <span class="badge badge-light" id="hoistText"></span>
            <button type="button" class="btn btn-primary" title="hoist" onclick="incrementValue(this)">+</button>
            <button type="button" class="btn btn-warning" title="hoist" onclick="decrementValue(this)">-</button>
            Valor desejado: <input class="input-control" title="hoist" id="hoist" value=""
                onfocusout="updateValue(this)" onkeydown="updateValueEnter(this)"></input>
        </div>
        <div class="control-element">
            Ferramenta:
            <span class="badge badge-light" id="suctionText"></span>
            <button type="button" class="" title="suction" id="suctionButton" onclick="toggleTool()"></button>
        </div>
    </div>
    <!-- <div class="start-stop-buttons">
        <button type="button" class="btn btn-success" onclick="startStatsRefresh()">Start</button>
        <button type="button" class="btn btn-danger" onclick="stopStatsRefresh()">Stop</button>
    </div> -->

    <script>
        let telemetryStatsRefreshMethod
        const updateTelemetry = () => {
            const armValue = document.getElementById('armText')
            const crabValue = document.getElementById('crabText')
            const hoistValue = document.getElementById('hoistText')
            const suctionValue = document.getElementById('suctionText')
            const suctionButton = document.getElementById('suctionButton')

            fetch("/simulation_data", {
                method: "GET"
            }).then(response => response.json()).then(telemetryStats => {
                console.log(telemetryStats)
                armValue.textContent = telemetryStats.arm_actuator
                crabValue.textContent = telemetryStats.crab_actuator
                hoistValue.textContent = telemetryStats.hoist_actuator
                if (telemetryStats.suction_pad) {
                    suctionValue.textContent = "Ativado"
                    suctionButton.textContent = "Desativar"
                    suctionButton.className = "btn btn-danger"
                } else {
                    suctionValue.textContent = "Desativado"
                    suctionButton.textContent = "Ativar"
                    suctionButton.className = "btn btn-success"
                }
            })

            telemetryStatsRefreshMethod = window.setTimeout(updateTelemetry, 500)
        }

        const startStatsRefresh = () => telemetryStatsRefreshMethod = window.setTimeout(updateTelemetry, 500)
        const stopStatsRefresh = () => clearTimeout(telemetryStatsRefreshMethod)

        startStatsRefresh()

        const updateValue = (input) => {
            fetch(`/update_${input.title}_actuator/${input.value}`, {
                method: "POST",
                body: {}
            }).then(() => {
                input.value = ''
            });
        }

        const updateValueEnter = (input) => {
            if (event.key === 'Enter') {
                updateValue(input)
            }
        }

        const decIncValue = (button, amount) => {
            const currValue = parseInt(document.getElementById(`${button.title}Text`).textContent)
            const input = document.getElementById(button.title)
            input.value = currValue + amount;
            updateValue(input)
        }

        const incrementValue = (button) => {
            decIncValue(button, 10)
        }

        const decrementValue = (button) => {
            decIncValue(button, -10)
        }

        const updateSuction = (value) => {
            fetch(`/update_suction_pad/${value}`, {
                method: "POST",
                body: {}
            });
        }

        const toggleTool = () => {
            const suctionValue = document.getElementById('suctionText')
            if (suctionValue.textContent === "Ativado") {
                updateSuction(0);
            }
            if (suctionValue.textContent === "Desativado") {
                updateSuction(1);
            }
        }
    </script>
</body>

</html>